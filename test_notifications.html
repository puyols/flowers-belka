<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - Flowers Belka</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.success { background: #28a745; }
        button.warning { background: #ffc107; color: #000; }
        button.danger { background: #dc3545; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.online { background: #d4edda; color: #155724; }
        .status.offline { background: #f8d7da; color: #721c24; }
        .notification-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .notification-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 10px;
        }
        .type-email { background: #007bff; color: white; }
        .type-sms { background: #28a745; color: white; }
        .type-push { background: #6f42c1; color: white; }
    </style>
</head>
<body>
    <h1>üìß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Flowers Belka</h1>
    
    <div class="container">
        <h2>üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</h2>
        <div id="system-status">–ü—Ä–æ–≤–µ—Ä—è–µ–º...</div>
        <button onclick="checkSystem()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É</button>
        <button onclick="createTables()">–°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã –ë–î</button>
    </div>

    <div class="grid">
        <!-- Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="container">
            <h2>üìß Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            
            <div class="form-group">
                <label>Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è:</label>
                <input type="email" id="email-to" value="test@example.com">
            </div>
            
            <div class="form-group">
                <label>–¢–µ–º–∞:</label>
                <input type="text" id="email-subject" value="–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">
            </div>
            
            <div class="form-group">
                <label>–®–∞–±–ª–æ–Ω:</label>
                <select id="email-template">
                    <option value="default">–û–±—ã—á–Ω—ã–π</option>
                    <option value="order_confirmation">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</option>
                    <option value="order_status">–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                <textarea id="email-message" rows="3">–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Flowers Belka!</textarea>
            </div>
            
            <button onclick="sendTestEmail()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å Email</button>
            <button onclick="testEmailConfig()">–¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</button>
            
            <div id="email-result" class="result">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
        </div>

        <!-- SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="container">
            <h2>üì± SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
            
            <div class="form-group">
                <label>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</label>
                <input type="tel" id="sms-phone" value="+7 999 123 45 67">
            </div>
            
            <div class="form-group">
                <label>–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
                <textarea id="sms-message" rows="3">Flowers Belka: –¢–µ—Å—Ç–æ–≤–æ–µ SMS —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ!</textarea>
            </div>
            
            <button onclick="sendTestSMS()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å SMS</button>
            
            <div id="sms-result" class="result">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
        </div>
    </div>

    <!-- Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="container">
        <h2>üîî Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h2>
        
        <div class="grid">
            <div>
                <div class="form-group">
                    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
                    <input type="text" id="push-title" value="–¢–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ">
                </div>
                
                <div class="form-group">
                    <label>–¢–µ–∫—Å—Ç:</label>
                    <textarea id="push-body" rows="2">–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Flowers Belka!</textarea>
                </div>
                
                <div class="form-group">
                    <label>URL:</label>
                    <input type="text" id="push-url" value="/">
                </div>
            </div>
            
            <div>
                <div id="push-status" class="status offline">Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è</div>
                <button id="push-subscribe" onclick="subscribeToPush()" disabled>–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</button>
                <button onclick="sendTestPush()" disabled id="push-send">–û—Ç–ø—Ä–∞–≤–∏—Ç—å Push</button>
            </div>
        </div>
        
        <div id="push-result" class="result">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
    </div>

    <!-- –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div class="container">
        <h2>üõí –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö</h2>
        
        <div class="form-group">
            <label>ID –∑–∞–∫–∞–∑–∞:</label>
            <input type="number" id="order-id" value="1" min="1">
        </div>
        
        <div class="form-group">
            <label>–¢–∏–ø —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</label>
            <select id="order-type">
                <option value="confirmation">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</option>
                <option value="status_change">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞</option>
                <option value="delivery">–ü–µ—Ä–µ–¥–∞—á–∞ –≤ –¥–æ—Å—Ç–∞–≤–∫—É</option>
            </select>
        </div>
        
        <button onclick="sendOrderNotifications()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ</button>
        
        <div id="order-result" class="result">–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div class="container">
        <h2>üìã –ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</h2>
        
        <button onclick="loadNotifications()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
        <button onclick="clearResults()">–û—á–∏—Å—Ç–∏—Ç—å</button>
        
        <div id="notifications-list">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
    </div>

    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤ -->
    <div class="container">
        <h2>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h2>
        <div id="test-summary">
            <p>–¢–µ—Å—Ç—ã –µ—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å</p>
        </div>
        <button onclick="runAllTests()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
    </div>

    <script>
        let testResults = { passed: 0, failed: 0, tests: [] };
        let pushSubscription = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        window.onload = function() {
            checkSystem();
            checkPushSupport();
        };

        function checkPushSupport() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                document.getElementById('push-status').className = 'status online';
                document.getElementById('push-status').textContent = 'Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è';
                document.getElementById('push-subscribe').disabled = false;
                document.getElementById('push-send').disabled = false;
                
                // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                        return registration.pushManager.getSubscription();
                    })
                    .then(subscription => {
                        if (subscription) {
                            pushSubscription = subscription;
                            document.getElementById('push-subscribe').textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
                        }
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
        }

        async function checkSystem() {
            const statusDiv = document.getElementById('system-status');
            statusDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º—É...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=test_email&email=test@example.com');
                
                if (response.ok) {
                    const data = await response.json();
                    statusDiv.innerHTML = `
                        <div class="status online">‚úÖ API —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: –†–∞–±–æ—Ç–∞–µ—Ç</div>
                        <div class="status online">‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: –ü–æ–¥–∫–ª—é—á–µ–Ω–∞</div>
                        <div class="status ${data.success ? 'online' : 'offline'}">
                            ${data.success ? '‚úÖ' : '‚ùå'} Email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ${data.message}
                        </div>
                    `;
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="status offline">‚ùå –°–∏—Å—Ç–µ–º–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞</div>
                    <p>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ PHP —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω: <code>php -S localhost:8080</code></p>
                `;
            }
        }

        async function createTables() {
            try {
                const response = await fetch('create_notifications_tables.sql');
                const sql = await response.text();
                
                // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ SQL –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                alert('SQL —Å–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω. –í—ã–ø–æ–ª–Ω–∏—Ç–µ –µ–≥–æ –≤ MySQL:\n\n' + sql.substring(0, 500) + '...');
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ SQL —Å–∫—Ä–∏–ø—Ç–∞: ' + error.message);
            }
        }

        async function sendTestEmail() {
            const resultDiv = document.getElementById('email-result');
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º email...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=send_email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        to: document.getElementById('email-to').value,
                        subject: document.getElementById('email-subject').value,
                        message: document.getElementById('email-message').value,
                        template: document.getElementById('email-template').value,
                        data: {
                            order_id: '123',
                            total: '5000',
                            address: '–≥. –ü—É—Ç–∏–ª–∫–æ–≤–æ, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, –¥. 1',
                            phone: '+7 999 123 45 67'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${data.message}`;
                    addTestResult('Email –æ—Ç–ø—Ä–∞–≤–∫–∞', true);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                addTestResult('Email –æ—Ç–ø—Ä–∞–≤–∫–∞', false, error.message);
            }
        }

        async function testEmailConfig() {
            const resultDiv = document.getElementById('email-result');
            resultDiv.textContent = '–¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é email...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=test_email&email=' + 
                    encodeURIComponent(document.getElementById('email-to').value));
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${data.message}`;
                    addTestResult('Email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è', true);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                addTestResult('Email –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è', false, error.message);
            }
        }

        async function sendTestSMS() {
            const resultDiv = document.getElementById('sms-result');
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º SMS...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=send_sms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: document.getElementById('sms-phone').value,
                        message: document.getElementById('sms-message').value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${data.message}`;
                    addTestResult('SMS –æ—Ç–ø—Ä–∞–≤–∫–∞', true);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                addTestResult('SMS –æ—Ç–ø—Ä–∞–≤–∫–∞', false, error.message);
            }
        }

        async function subscribeToPush() {
            try {
                const registration = await navigator.serviceWorker.ready;
                
                if (pushSubscription) {
                    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                    await pushSubscription.unsubscribe();
                    pushSubscription = null;
                    document.getElementById('push-subscribe').textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                    document.getElementById('push-result').textContent = '–û—Ç–ø–∏—Å–∞–ª–∏—Å—å –æ—Ç push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π';
                } else {
                    // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                    const subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: urlBase64ToUint8Array('your-vapid-public-key')
                    });
                    
                    pushSubscription = subscription;
                    document.getElementById('push-subscribe').textContent = '–û—Ç–ø–∏—Å–∞—Ç—å—Å—è';
                    document.getElementById('push-result').textContent = '–ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                    await fetch('http://localhost:8080/api_notifications.php?action=subscribe_push', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            subscription: JSON.stringify(subscription),
                            user_id: 0
                        })
                    });
                }
            } catch (error) {
                document.getElementById('push-result').textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
        }

        async function sendTestPush() {
            if (!pushSubscription) {
                document.getElementById('push-result').textContent = '–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Ç–µ—Å—å –Ω–∞ push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è';
                return;
            }

            const resultDiv = document.getElementById('push-result');
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=send_push', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        subscription: JSON.stringify(pushSubscription),
                        title: document.getElementById('push-title').value,
                        body: document.getElementById('push-body').value,
                        url: document.getElementById('push-url').value,
                        icon: '/icon-192x192.png'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${data.message}`;
                    addTestResult('Push –æ—Ç–ø—Ä–∞–≤–∫–∞', true);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                addTestResult('Push –æ—Ç–ø—Ä–∞–≤–∫–∞', false, error.message);
            }
        }

        async function sendOrderNotifications() {
            const resultDiv = document.getElementById('order-result');
            resultDiv.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=order_notifications', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: parseInt(document.getElementById('order-id').value),
                        type: document.getElementById('order-type').value,
                        status: '–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ ${data.message}\n\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:\n${JSON.stringify(data.results, null, 2)}`;
                    addTestResult('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ', true);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                addTestResult('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–µ', false, error.message);
            }
        }

        async function loadNotifications() {
            const listDiv = document.getElementById('notifications-list');
            listDiv.innerHTML = '–ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é...';
            
            try {
                const response = await fetch('http://localhost:8080/api_notifications.php?action=get_notifications&user_id=0&limit=20');
                const data = await response.json();
                
                if (data.success && data.notifications.length > 0) {
                    let html = '<h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</h3>';
                    
                    data.notifications.forEach(notification => {
                        html += `
                            <div class="notification-item">
                                <span class="notification-type type-${notification.type}">${notification.type.toUpperCase()}</span>
                                <strong>${notification.subject || '–ë–µ–∑ —Ç–µ–º—ã'}</strong>
                                <p>${notification.message}</p>
                                <small>–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${notification.recipient} | 
                                       –°—Ç–∞—Ç—É—Å: ${notification.success ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : '–û—à–∏–±–∫–∞'} | 
                                       –í—Ä–µ–º—è: ${new Date(notification.created_at).toLocaleString('ru-RU')}</small>
                            </div>
                        `;
                    });
                    
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<p>–ò—Å—Ç–æ—Ä–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞</p>';
                }
            } catch (error) {
                listDiv.innerHTML = `<p style="color: red;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>`;
            }
        }

        function clearResults() {
            document.getElementById('notifications-list').innerHTML = '–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞';
        }

        function addTestResult(testName, success, error = null) {
            if (success) {
                testResults.passed++;
            } else {
                testResults.failed++;
            }
            
            testResults.tests.push({
                name: testName,
                success,
                error,
                timestamp: new Date().toLocaleTimeString()
            });
            
            updateTestSummary();
        }

        function updateTestSummary() {
            const summaryDiv = document.getElementById('test-summary');
            const total = testResults.passed + testResults.failed;
            
            let html = `
                <h3>üìä –°–≤–æ–¥–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <p><strong>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:</strong> ${total}</p>
                <p><strong>–£—Å–ø–µ—à–Ω–æ:</strong> <span style="color: green;">${testResults.passed}</span></p>
                <p><strong>–û—à–∏–±–æ–∫:</strong> <span style="color: red;">${testResults.failed}</span></p>
                
                <h4>–î–µ—Ç–∞–ª–∏:</h4>
                <ul>
            `;
            
            testResults.tests.forEach(test => {
                const icon = test.success ? '‚úÖ' : '‚ùå';
                const error = test.error ? ` - ${test.error}` : '';
                html += `<li>${icon} ${test.name} (${test.timestamp})${error}</li>`;
            });
            
            html += '</ul>';
            
            if (total > 0) {
                const successRate = Math.round((testResults.passed / total) * 100);
                html += `<p><strong>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å:</strong> ${successRate}%</p>`;
            }
            
            summaryDiv.innerHTML = html;
        }

        async function runAllTests() {
            testResults = { passed: 0, failed: 0, tests: [] };
            
            await checkSystem();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testEmailConfig();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await sendTestEmail();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await sendTestSMS();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            if (pushSubscription) {
                await sendTestPush();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            await sendOrderNotifications();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await loadNotifications();
        }

        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }
    </script>
</body>
</html>
